# MySQLäº‹åŠ¡

> MySQLä¸­ï¼Œäº‹ç‰©æ˜¯ä¸€ä¸ªæœ€å°çš„ä¸å¯åˆ†å‰²çš„å·¥ä½œå•å…ƒï¼Œäº‹ç‰©èƒ½å¤Ÿä¿è¯ä¸€ä¸ªä¸šåŠ¡çš„å®Œæ•´æ€§

## ç±»æ¯”é“¶è¡Œè½¬è´¦

aå–èµ°äº†100å…ƒï¼š

`update user set money=money-100 where name='a';`

bæ”¶å…¥äº†100å…ƒ

`update user set money=money+100 where name='b';`

åœ¨å®žé™…ç¨‹åºä¸­å¯èƒ½ä¼šå‡ºçŽ°ä¸€æ¡è¯­å¥æ‰§è¡ŒæˆåŠŸï¼Œè€Œå¦ä¸€æ¡æ²¡æœ‰æ‰§è¡ŒæˆåŠŸï¼Œä¼šé€ æˆæ•°æ®å‰åŽä¸ä¸€è‡´çš„çŽ°è±¡ã€‚æœ‰æ—¶å¤šæ¡sqlè¯­å¥å¯èƒ½ä¼šæœ‰è¦ä¹ˆåŒæ—¶æˆåŠŸè¦ä¹ˆåŒæ—¶å¤±è´¥çš„è¦æ±‚ã€‚

## MySQLå¦‚ä½•æŽ§åˆ¶äº‹åŠ¡

MySQLæ˜¯é»˜è®¤å¼€å¯äº‹åŠ¡çš„ï¼š

**è¾“å…¥**

```mysql
select @@autocommit;
```

**è¿”å›ž**

```mysql
+--------------+
| @@autocommit |
+--------------+
|            1 |
+--------------+
1 row in set (0.00 sec)
```

> é»˜è®¤äº‹åŠ¡å¼€å¯çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿå½“æˆ‘ä»¬åŽ»æ‰§è¡Œä¸€ä¸ªsqlè¯­å¥çš„æ—¶å€™ï¼Œæ•ˆæžœä¼šç«‹å³ä½“çŽ°å‡ºæ¥ä¸”ä¸ä¼šå›žæ»šã€‚

### è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼šåˆ›å»ºä¸€ä¸ªæ•°æ®åº“ã€æ·»åŠ ä¸€ä¸ªæ•°æ®è¡¨ã€æ’å…¥ä¸€è¡Œæ•°æ®

```mysql
create database rbtest;
create table test(
    id int primary key,
    name varchar(20),
    money int
);
insert into test values(1,'ZhangSan',100);
```

### å±•ç¤ºå½“å‰è¡¨æ ¼å¦‚ä¸‹

```mysql
+----+----------+-------+
| id | name     | money |
+----+----------+-------+
|  1 | ZhangSan |   100 |
+----+----------+-------+
1 row in set (0.00 sec)
```

### å›žæ»š

**è¾“å…¥**

```mysql
rollback;
```

**è¿”å›ž**

```mysql
Query OK, 0 rows affected (0.00 sec)
```

**è¯´æ˜Žå½“å‰è¡¨æ ¼æ²¡æœ‰æˆåŠŸå›žæ»šï¼ŒæŸ¥è¯¢åŽè¡¨æ ¼å’Œä¸Šé¢ä¸€è‡´**

> åŽŸå› æ˜¯MySQLé»˜è®¤äº‹åŠ¡å¼€å¯ï¼Œæˆ‘ä»¬ä¸èƒ½è¿›è¡Œå›žæ»šæ“ä½œ

### è®¾ç½®é»˜è®¤äº‹åŠ¡å…³é—­ï¼ˆè‡ªåŠ¨æäº¤å…³é—­ï¼‰

```mysql
set @@autocommit=0;;
```

### å†è¿›è¡Œæ’å…¥æ“ä½œï¼Œå°è¯•æ˜¯å¦å¯ä»¥å›žæ»š

**è¾“å…¥**

```
insert into test values(2,'LiSi',200);
insert into test values(3,'WangWu',500);
select * from test;
rollback;
select * from test;
```

**è¿”å›ž**

```mysql
+----+----------+-------+
| id | name     | money |
+----+----------+-------+
|  1 | ZhangSan |   100 |
|  2 | LiSi     |   200 |
|  3 | WangWu   |   500 |
+----+----------+-------+
3 rows in set (0.00 sec)


+----+----------+-------+
| id | name     | money |
+----+----------+-------+
|  1 | ZhangSan |   100 |
+----+----------+-------+
1 row in set (0.00 sec)
```

è¯´æ˜Žä¸¤ä¸ªæ’å…¥æ“ä½œéƒ½æ²¡æœ‰ç”Ÿæ•ˆï¼Œä¸ºäº†åœ¨è‡ªåŠ¨æäº¤å…³é—­çš„æƒ…å†µä¸‹æˆåŠŸä½¿æ“ä½œç”Ÿæ•ˆï¼Œéœ€è¦åœ¨ä¸€æ®µæ“ä½œä¹‹åŽæ·»åŠ commitè¯­å¥ï¼š

**è¾“å…¥**

```mysql
insert into test values(2,'LiSi',200);
insert into test values(3,'WangWu',500);
commit;
select * from test;
rollback;
select * from test;
```

**è¿”å›ž**

```mysql
+----+----------+-------+
| id | name     | money |
+----+----------+-------+
|  1 | ZhangSan |   100 |
|  2 | LiSi     |   200 |
|  3 | WangWu   |   500 |
+----+----------+-------+
3 rows in set (0.00 sec)

+----+----------+-------+
| id | name     | money |
+----+----------+-------+
|  1 | ZhangSan |   100 |
|  2 | LiSi     |   200 |
|  3 | WangWu   |   500 |
+----+----------+-------+
3 rows in set (0.00 sec)
```

## å›žåˆ°é“¶è¡Œè½¬è´¦

### åˆ›å»ºä¸€ä¸ªè´¦å•

```mysql
create table money(id int, name varchar(20), money int);
```

### è®¾ç½®ä¸¤äººåŽŸå§‹å­˜æ¬¾

```mysql
insert into money values(1,'a',1000);
insert into money values(2,'b',2000);
```

### æäº¤ä¸Šè¿°æ“ä½œ

```mysql
commit;
```

### æŸ¥çœ‹ä¸¤äººå½“å‰ä½™é¢

```mysql
+------+------+-------+
| id   | name | money |
+------+------+-------+
|    1 | a    |  1000 |
|    2 | b    |  2000 |
+------+------+-------+
2 rows in set (0.00 sec)
```

### è¿›è¡Œè½¬è´¦æ“ä½œ

```mysql
update money set money=money-100 where name='a';
update money set money=money+100 where name='b';
```

### æŸ¥è¯¢ä¸¤äººå½“å‰ä½™é¢

```mysql
+------+------+-------+
| id   | name | money |
+------+------+-------+
|    1 | a    |   900 |
|    2 | b    |  2100 |
+------+------+-------+
2 rows in set (0.00 sec)
```

### å‘çŽ°è½¬è´¦æ“ä½œé”™è¯¯ï¼Œè¿›è¡Œå›žæ»š

```mysql
rollback;
```

### ç„¶åŽæŸ¥è¯¢ä¸¤äººå½“å‰ä½™é¢

```mysql
+------+------+-------+
| id   | name | money |
+------+------+-------+
|    1 | a    |  1000 |
|    2 | b    |  2000 |
+------+------+-------+
2 rows in set (0.00 sec)
```

## åœ¨@@autocommit=1çš„æƒ…å†µä¸‹ä¸ºæŸæ®µä»£ç å¼€å¯äº‹åŠ¡

> è®¾ç½®@@autocommit=0çš„è¯æœ‰ä¸ªç¼ºç‚¹ï¼Œæ¯æ®µä»£ç æ•²å®ŒåŽéƒ½è¦æ‰‹åŠ¨commitï¼Œä½†æ˜¯æœ‰æ—¶å€™åªéœ€è¦ä¸ºæŸæ®µå…³é”®ä»£ç å¼€å¯äº‹åŠ¡ã€‚

```mysql
begin;
...
commit;
```

æˆ–è€…

```mysql
start transcacion;
...
commit;
```

## äº‹åŠ¡å››å¤§ç‰¹å¾

- Aï¼šåŽŸå­æ€§ï¼ˆäº‹åŠ¡æ˜¯æœ€å°çš„å•ä½ï¼Œä¸å¯ä»¥å†åˆ†å‰²ï¼‰
- Cï¼šä¸€è‡´æ€§ï¼ˆäº‹åŠ¡è¦æ±‚ï¼ŒåŒä¸€äº‹åŠ¡ä¸­çš„sqlè¯­å¥ï¼Œå¿…é¡»ä¿è¯åŒæ—¶æˆåŠŸæˆ–åŒæ—¶å¤±è´¥ï¼‰
- Iï¼šéš”ç¦»æ€§ï¼ˆäº‹åŠ¡1å’Œäº‹åŠ¡2ä¹‹é—´æ˜¯å…·æœ‰éš”ç¦»æ€§çš„ï¼‰
- Dï¼šæŒä¹…æ€§ï¼ˆäº‹åŠ¡ä¸€æ—¦ç»“æŸï¼Œå°±ä¸å¯ä»¥è¿”å›žï¼‰

## äº‹åŠ¡æ“ä½œæ€»ç»“

### äº‹åŠ¡å¼€å¯æ–¹å¼

- `set @@autocommit=0;`
- `begin...commit`
- `start transcation...commit`

### äº‹åŠ¡æ‰‹åŠ¨æäº¤

``commit`

### äº‹åŠ¡æ‰‹åŠ¨å›žæ»š

`rollback`

## äº‹åŠ¡çš„éš”ç¦»æ€§

### æŸ¥çœ‹éš”ç¦»çº§åˆ«

MySQL8.0

```mysql
select @@global.transaction_isolation;
```

MySQL5.x

**è¾“å…¥**

```mysql
select @@global.tx_isolation;
```

**è¿”å›ž**

```mysql
+-----------------------+
| @@global.tx_isolation |
+-----------------------+
| REPEATABLE-READ       |
+-----------------------+
1 row in set (0.00 sec)
```

### ä¿®æ”¹éš”ç¦»çº§åˆ«

**è¾“å…¥**

```mysql
set global transaction isolation level read uncommitted;
```

**è¿”å›ž**

```mysql
+-----------------------+
| @@global.tx_isolation |
+-----------------------+
| READ-UNCOMMITTED      |
+-----------------------+
1 row in set (0.00 sec)
```

### éš”ç¦»çº§åˆ«

#### `read uncommitted`ï¼šè¯»æœªæäº¤çš„

> å¦‚æžœæœ‰äº‹åŠ¡aï¼Œäº‹åŠ¡bï¼šaäº‹åŠ¡å¯¹æ•°æ®è¿›è¡Œæ“ä½œï¼Œåœ¨æ“ä½œè¿‡ç¨‹ä¸­ï¼Œäº‹åŠ¡æ²¡æœ‰è¢«æäº¤ï¼Œä½†æ˜¯bå¯ä»¥çœ‹è§aæ“ä½œçš„ç»“æžœ

##### è„è¯»

å¦‚æžœä¸¤ä¸ªä¸åŒçš„åœ°æ–¹éƒ½åœ¨è¿›è¡Œæ“ä½œï¼Œå¦‚æžœäº‹åŠ¡aå¼€å¯ä¹‹åŽï¼ˆREAD-UNCOMMITTEDï¼‰ï¼Œä»–å®ƒæœªæäº¤çš„æ•°æ®å¯ä»¥è¢«å…¶ä»–äº‹åŠ¡è¯»å–åˆ°ï¼Œè¿™æ ·å°±ä¼šå‡ºçŽ°**è„è¯»**ã€‚

#### `read committed`ï¼šè¯»å·²ç»æäº¤çš„

##### ä¸å¯é‡å¤è¯»çŽ°è±¡

è™½ç„¶æˆ‘åªèƒ½è¯»åˆ°å¦å¤–ä¸€ä¸ªäº‹åŠ¡æäº¤çš„æ•°æ®ï¼Œä½†è¿˜æ˜¯ä¼šå‡ºçŽ°é—®é¢˜ï¼Œå°±æ˜¯è¯»å–åŒä¸€ä¸ªè¡¨çš„æ•°æ®å‘çŽ°å‰åŽä¸ä¸€è‡´ï¼ˆåœ¨ä¸¤ä¸ªæ“ä½œä¹‹é—´åˆ«äººä¿®æ”¹å¹¶æäº¤äº†æ•°æ®ï¼‰ï¼Œè¿™å°±æ˜¯ä¸å¯é‡å¤è¯»çŽ°è±¡ã€‚

#### `repeatable read`ï¼šå¯ä»¥é‡å¤è¯»

##### å¹»è¯»

äº‹åŠ¡aæ“ä½œå’Œäº‹åŠ¡båŒæ—¶æ“ä½œä¸€å¼ è¡¨ï¼Œäº‹åŠ¡aæäº¤çš„æ•°æ®ä¹Ÿä¸èƒ½è¢«äº‹åŠ¡bè¯»åˆ°ï¼Œå°±å¯èƒ½é€ æˆå¹»è¯»

#### `serializable`ï¼šä¸²è¡ŒåŒ–

> å½“ä¸€ä¸ªè¡¨è¢«å¦ä¸€ä¸ªäº‹åŠ¡æ“ä½œçš„æ—¶å€™ï¼Œå…¶ä»–äº‹åŠ¡é‡Œé¢çš„å†™æ“ä½œæ˜¯ ä¸å¯ä»¥è¿›è¡Œçš„ï¼Œè€Œæ˜¯è¿›å…¥æŽ’é˜ŸçŠ¶æ€ï¼Œï¼ˆåœ¨æ²¡æœ‰ç­‰å¾…è¶…æ—¶çš„å‰æä¸‹ï¼‰ç›´åˆ°æ“ä½œäº‹åŠ¡ç»“æŸåŽï¼Œè¿™ä¸ªå†™æ“ä½œæ‰ä¼šæ‰§è¡Œã€‚

ä¸²è¡ŒåŒ–çš„é—®é¢˜æ˜¯ï¼šæ€§èƒ½ç‰¹å·®

**éš”ç¦»çº§åˆ«è¶Šé«˜æ€§èƒ½è¶Šå·®**ï¼šæ€§èƒ½`read uncommitted` > `read committed` > `repeatable read` > `serializable`

**MySQLé»˜è®¤éš”ç¦»çº§åˆ«æ˜¯ï¼š**`repeatable read`

# å…¶ä»–ç¬”è®°é“¾æŽ¥

ðŸ”—https://github.com/hjzCy/sql_node/blob/master/mysql/MySQL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.md

ðŸ”—https://github.com/XiangLinPro/IT_book#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95%E7%9B%B8%E5%85%B3%E4%B9%A6%E7%B1%8D